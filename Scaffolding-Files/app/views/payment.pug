extends default_web_logged-in_layout.pug

block styles
  link(rel="stylesheet", href="/css/payment.css")

block content
  .payment-details-container
    h2 Payment Details

    form(action="/process-payment", method="POST", id="paymentForm")
        input(type="hidden", name="transactionIds", value=`${transactionId}`)
        input(type="hidden", name="userId", value=`${userId}`)
        input(type="hidden", name="totalAmount", value=`${totalAmount}`)

        if totalAmount === 0
            p Your order is free! You will be redirected to confirmation.
        else
            .form-group
                label.required(for="paymentType") Payment Type:
                select(name='paymentType', id='paymentType', required)
                    option(value='', disabled selected) Payment type
                    option(value='card') Card Payment
                    option(value='bank_transfer') Bank Transfer

            div#card-details(style='display:none;')
                .form-group
                    label.required(for="cardNumber") Card Number:
                    input(type="text", name="cardNumber", id="cardNumber", required)
                .form-group
                    label.required(for="expiryMonth") Expiry Month:
                    select(name="expiryMonth", id="expiryMonth", required)
                        option(value="01") 01 - January
                        option(value="02") 02 - February
                        option(value="03") 03 - March
                        option(value="04") 04 - April
                        option(value="05") 05 - May
                        option(value="06") 06 - June
                        option(value="07") 07 - July
                        option(value="08") 08 - August
                        option(value="09") 09 - September
                        option(value="10") 10 - October
                        option(value="11") 11 - November
                        option(value="12") 12 - December
                .form-group
                    label.required(for="expiryYear") Expiry Year:
                    select(name="expiryYear", id="expiryYear", required)
                        - var currentYear = new Date().getFullYear()
                        - for (var i = 0; i < 10; i++)
                            option(value=currentYear + i) #{currentYear + i}

            div#bank-details(style='display:none;')
                .form-group
                    label.required(for="accountNumber") Account Number (8 digits):
                    input(type="text", name="accountNumber", id="accountNumber", pattern="[0-9]{8}", title="Enter 8 digits", required)
                .form-group
                    label.required(for="sortCode") Sort Code (6 digits):
                    input(type="text", name="sortCode", id="sortCode", pattern="[0-9]{6}", title="Enter 6 digits", required)

        .payment-summary
            h3 Payment Summary
            .summary-totals
                if showBreakdown
                    .total-item
                        span Subtotal:
                        span £#{subtotal.toFixed(2)}
                    .total-item
                        span Delivery:
                        span £#{deliveryCost.toFixed(2)}
                    .total-item.final-total
                        span Amount to Pay:
                        span £#{(subtotal + deliveryCost).toFixed(2)}

            div.button-container
                a(href=`/delivery/${transactionId}`) ← Back to Shipping
                button(type="submit") Confirm

    script.
        const paymentTypeSelect = document.getElementById('paymentType');
        const cardDetails = document.getElementById('card-details');
        const bankDetails = document.getElementById('bank-details');
        const paymentForm = document.getElementById('paymentForm');

        paymentTypeSelect.addEventListener('change', function() {
            if (this.value === 'card') {
                cardDetails.style.display = 'block';
                bankDetails.style.display = 'none';
            } else if (this.value === 'bank_transfer') {
                cardDetails.style.display = 'none';
                bankDetails.style.display = 'block';
            } else {
                cardDetails.style.display = 'none';
                bankDetails.style.display = 'none';
            }
        });

        paymentForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData(paymentForm);
            const data = Object.fromEntries(formData);
            data.transactionIds = [data.transactionIds];

            if (parseFloat(data.totalAmount) === 0) {
                window.location.href = `/confirmation/free`;
                return;
            }

            try {
                const response = await fetch('/process-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                const result = await response.json();

                if (response.ok) {
                    window.location.href = `/confirmation/${result.paymentId}`;
                } else {
                    console.error("Payment failed", result.error);
                    alert("Payment failed: " + result.error);
                }
            } catch (error) {
                console.error("Network error: ", error);
                alert("Network error. Please try again.");
            }
        });