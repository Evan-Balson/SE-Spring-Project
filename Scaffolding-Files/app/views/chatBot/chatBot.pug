extends ../default_web_logged-in_layout.pug

// Include the external stylesheet in the head block.
block head
  link(rel="stylesheet", href="/styles/chat.css")

block content
  .chat-container
    h1 Chat with our Bot
    // Conversation History Container
    #chat-history
      // Messages will be appended here

    // Chat Input Form
    form#chat-form
      input(type='text', id='message', placeholder='Type your message here', autocomplete='off')
      button(type='submit') Send

  // Client-side JavaScript for handling chat interactions
  script.
    // Helper function to append a message to the conversation container.
    function appendMessage(text, className, includeLink, outfitLinkHTML) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('chat-message', className);
      // If a link should be included along with the text (for outfit IDs).
      if (includeLink && outfitLinkHTML) {
        messageDiv.innerHTML = text + ' ' + outfitLinkHTML;
      } else {
        messageDiv.textContent = text;
      }
      document.getElementById('chat-history').appendChild(messageDiv);
      // Auto-scroll to the latest message.
      const chatHistory = document.getElementById('chat-history');
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    document.getElementById('chat-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageInput = document.getElementById('message');
      const userMessage = messageInput.value.trim();
      if (!userMessage) return;
      
      // Append user's message to chat history.
      appendMessage('User: ' + userMessage, 'user-message');

      // Clear the input for the next message.
      messageInput.value = '';

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: userMessage })
        });
        const data = await response.json();

        // If the reply includes outfit IDs, add a link to the outfit listing page.
        if (data.outfitIDs) {
          const outfitLink = '<a href="/outfit-listing" style="text-decoration:underline;">View Full Outfit Details</a>';
          appendMessage('Bot: ' + data.reply, 'bot-message', true, outfitLink);
        } else {
          // Append normal text response.
          appendMessage('Bot: ' + data.reply, 'bot-message');
        }
      } catch (error) {
        console.error('Error fetching chat response:', error);
        appendMessage('Bot: Sorry, something went wrong.', 'bot-message');
      }
    });
